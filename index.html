<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>ارزیابی عملکرد کادر مدرسه</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
            font-size: 14px;
            color: #1F2937; /* مشکی برای فونت */
        }
        body {
            background: linear-gradient(45deg, #A5B4FC, #C4B5FD, #DDD6FE, #EDE9FE);
            background-size: 400%;
            animation: gradient 15s ease infinite;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        body.light-theme {
            background: linear-gradient(45deg, #E0E7FF, #EDE9FE, #DDD6FE, #C4B5FD);
        }
        header {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            text-align: center;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(8px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        header h1, header h2, header h3 {
            color: #1F2937;
        }
        .hamburger {
            display: none;
            font-size: 24px;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 20px;
            color: #1F2937;
        }
        .nav-menu {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .nav-menu.hidden {
            display: none;
        }
        .container {
            margin-top: 100px;
            padding: 20px;
            max-width: 1200px;
            margin-left: auto;
            margin-right: auto;
        }
        .login-container, .dashboard {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .login-container:hover, .dashboard:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        input, select, textarea, button {
            font-family: 'Vazirmatn', sans-serif;
            font-size: 14px;
            padding: 10px;
            margin: 8px;
            border-radius: 8px;
            border: 1px solid #D1D5DB;
            transition: all 0.3s ease;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #A5B4FC;
            outline: none;
            box-shadow: 0 0 8px rgba(165, 180, 252, 0.3);
        }
        button {
            background: #A5B4FC;
            color: #1F2937;
            cursor: pointer;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        button:hover {
            background: #C4B5FD;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }
        #dashboard-menu button {
            position: relative;
            padding: 12px 20px;
            background: #A5B4FC;
            color: #1F2937;
            border-radius: 10px;
            transition: all 0.3s ease;
            transform: perspective(500px) translateZ(0);
        }
        #dashboard-menu button:hover {
            transform: perspective(500px) translateZ(15px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            background: #C4B5FD;
        }
        #dashboard-menu button:active {
            transform: perspective(500px) translateZ(5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #D1D5DB;
            padding: 12px;
            text-align: center;
        }
        th {
            background: #A5B4FC;
            color: #1F2937;
            font-weight: 700;
        }
        .light-theme th {
            background: #C4B5FD;
            color: #1F2937;
        }
        .checkbox-container {
            display: inline-block;
            position: relative;
            padding-right: 35px;
            cursor: pointer;
            margin: 8px;
        }
        .checkbox-container input {
            position: absolute;
            opacity: 0;
            cursor: pointer;
        }
        .checkmark {
            position: absolute;
            top: 2px;
            right: 8px;
            height: 22px;
            width: 22px;
            background-color: #E5E7EB;
            border-radius: 6px;
            transition: background-color 0.3s;
        }
        .checkbox-container input:checked ~ .checkmark {
            background-color: #A5B4FC;
        }
        .checkmark:after {
            content: "";
            position: absolute;
            display: none;
        }
        .checkbox-container input:checked ~ .checkmark:after {
            display: block;
        }
        .checkbox-container .checkmark:after {
            right: 8px;
            top: 4px;
            width: 6px;
            height: 12px;
            border: solid #1F2937;
            border-width: 0 3px 3px 0;
            transform: rotate(45deg);
        }
        canvas.chart {
            max-width: 100%;
            margin: 20px 0;
            border-radius: 8px;
            background: #fff;
            padding: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        footer {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            color: #1F2937;
            position: relative;
            bottom: 0;
            width: 100%;
            margin-top: 30px;
            backdrop-filter: blur(8px);
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
        }
        @media print {
            header, .nav-menu, footer, .dashboard button {
                display: none;
            }
            .container {
                margin-top: 0;
            }
            body {
                background: #fff;
                color: #1F2937;
            }
            .dashboard, .section {
                background: #fff;
                box-shadow: none;
            }
            th {
                background: #A5B4FC;
                color: #1F2937;
            }
            .light-theme th {
                background: #C4B5FD;
                color: #1F2937;
            }
        }
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            header h1 {
                font-size: 16px;
            }
            header h2 {
                font-size: 14px;
            }
            header h3 {
                font-size: 12px;
            }
            table {
                font-size: 12px;
            }
            .hamburger {
                display: block;
            }
            .nav-menu {
                display: none;
                flex-direction: column;
                width: 100%;
                background: rgba(255, 255, 255, 0.95);
                padding: 10px;
            }
            .nav-menu.active {
                display: flex;
            }
            #people .form-container {
                display: flex;
                flex-direction: column;
                gap: 10px;
                width: 100%;
            }
            #people input, #people select {
                width: 100%;
                margin: 5px 0;
            }
            #people button {
                width: 100%;
                margin: 10px 0;
            }
            .filter-container {
                flex-direction: column;
                gap: 10px;
            }
            .filter-container select, .filter-container input {
                width: 100%;
                margin: 5px 0;
            }
        }
        .widget {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .hidden {
            display: none;
        }
        .person-details {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .filter-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        .filter-container select, .filter-container input {
            flex: 1;
            min-width: 150px;
            margin: 5px;
        }
        .search-input {
            width: 100%;
            max-width: 300px;
            margin: 10px auto;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #D1D5DB;
        }
        .search-input:focus {
            border-color: #A5B4FC;
            box-shadow: 0 0 8px rgba(165, 180, 252, 0.3);
        }
        .analysis-table {
            margin-top: 20px;
            background: #F9FAFB;
            border-radius: 8px;
            padding: 10px;
        }
        .report-analysis {
            margin-top: 20px;
            padding: 10px;
            background: #F3F4F6;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <header>
        <h1>بسم الله الرحمن الرحیم</h1>
        <h2>ارزیابی عملکرد کادر مدرسه 🌟</h2>
        <h3>خوش آمدید 😊</h3>
        <div class="hamburger" onclick="toggleMenu()">☰</div>
        <div class="nav-menu" id="nav-menu"></div>
    </header>
    <div class="container">
        <div id="login-container" class="login-container">
            <h3>ورود</h3>
            <input type="text" id="username" placeholder="نام کاربری">
            <input type="password" id="password" placeholder="رمز عبور">
            <button onclick="login()">ورود 🚪</button>
        </div>
        <div id="dashboard" class="dashboard hidden">
            <div class="widget">
                <h3>آمار 📊</h3>
                <p>تعداد افراد: <span id="total-people">0</span> 👥</p>
                <p>میانگین معدل: <span id="avg-grade">0</span> 📈</p>
            </div>
            <div class="widget" id="personalized-widget" class="hidden">
                <h3>گزارش‌های مرتبط با ناحیه ۳</h3>
                <p>میانگین نمرات ناحیه: <span id="district-avg">0</span> 📈</p>
            </div>
            <div class="nav-menu" id="dashboard-menu">
                <button onclick="showSection('change-password')">تغییر رمز 🔑</button>
                <button onclick="showSection('people')">تعریف افراد 👥</button>
                <button onclick="showSection('criteria')">تعریف معیارها 📋</button>
                <button onclick="showSection('report-card')">کارنامه 📝</button>
                <button onclick="showSection('summary')">خلاصه گزارش 📊</button>
                <button onclick="showSection('strategic-analysis')">تحلیل راهبردی 🧠</button>
                <button onclick="showSection('top-performers')">برترین‌ها 🏆</button>
                <button onclick="exportToJSON()">خروج JSON 📤</button>
                <button onclick="document.getElementById('json-input').click()">ورود JSON 📥</button>
                <input type="file" id="json-input" accept=".json" style="display: none;" onchange="importFromJSON(event)">
                <button onclick="document.getElementById('excel-input').click()">ورود اکسل 📥</button>
                <input type="file" id="excel-input" accept=".xlsx" style="display: none;" onchange="importFromExcel(event)">
            </div>

            <div id="change-password" class="section hidden">
                <h3>تغییر رمز 🔑</h3>
                <input type="password" id="new-password" placeholder="رمز جدید">
                <button onclick="changePassword()">ذخیره 🔄</button>
            </div>

            <div id="people" class="section hidden">
                <h3>تعریف افراد 👥</h3>
                <div class="form-container">
                    <input type="text" id="person-name" placeholder="نام و نام خانوادگی">
                    <input type="text" id="person-personnel-code" placeholder="کد پرسنلی">
                    <input type="text" id="person-national-code" placeholder="کد ملی">
                    <select id="person-role">
                        <option value="">انتخاب نقش</option>
                        <option value="مدیر">مدیر</option>
                        <option value="معاون آموزشی">معاون آموزشی</option>
                        <option value="آموزگار">آموزگار</option>
                    </select>
                    <input type="text" id="person-school-name" placeholder="نام مدرسه">
                    <select id="person-period">
                        <option value="">انتخاب دوره</option>
                        <option value="اول">اول</option>
                        <option value="دوم">دوم</option>
                    </select>
                    <select id="person-grade">
                        <option value="">انتخاب پایه (برای آموزگار)</option>
                        <option value="اول">اول</option>
                        <option value="دوم">دوم</option>
                        <option value="سوم">سوم</option>
                        <option value="چهارم">چهارم</option>
                        <option value="پنجم">پنجم</option>
                        <option value="ششم">ششم</option>
                        <option value="سایر">سایر</option>
                    </select>
                    <select id="person-gender">
                        <option value="">انتخاب جنسیت دانش‌آموزان</option>
                        <option value="دخترانه">دخترانه</option>
                        <option value="پسرانه">پسرانه</option>
                        <option value="مختلط">مختلط</option>
                    </select>
                    <select id="person-type">
                        <option value="">انتخاب نوع</option>
                        <option value="دولتی">دولتی</option>
                        <option value="غیردولتی">غیردولتی</option>
                    </select>
                    <input type="number" id="person-student-count" placeholder="تعداد دانش‌آموزان">
                    <select id="person-location">
                        <option value="">انتخاب موقعیت</option>
                        <option value="شهری">شهری</option>
                        <option value="روستایی">روستایی</option>
                    </select>
                    <button onclick="addPerson()">ثبت ➕</button>
                    <button onclick="clearAllPeople()" style="background: #EF4444; color: white;">حذف همه 🗑️</button>
                </div>
                <input type="text" class="search-input" id="people-search" placeholder="جستجوی افراد..." oninput="filterPeople()">
                <select id="person-filter" onchange="filterPeople()">
                    <option value="all">همه</option>
                    <option value="active">فعال</option>
                    <option value="inactive">غیرفعال</option>
                </select>
                <div class="table-container">
                    <table id="people-table">
                        <thead>
                            <tr>
                                <th>نام و نام خانوادگی</th>
                                <th>کد پرسنلی</th>
                                <th>کد ملی</th>
                                <th>نقش</th>
                                <th>نام مدرسه</th>
                                <th>دوره</th>
                                <th>پایه</th>
                                <th>جنسیت</th>
                                <th>نوع</th>
                                <th>تعداد دانش‌آموزان</th>
                                <th>موقعیت</th>
                                <th>وضعیت</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="criteria" class="section hidden">
                <h3>تعریف معیارها 📋</h3>
                <select id="criteria-role">
                    <option value="">انتخاب نقش برای معیار</option>
                    <option value="مدیر">مدیر</option>
                    <option value="معاون آموزشی">معاون آموزشی</option>
                    <option value="آموزگار">آموزگار</option>
                </select>
                <input type="text" id="criteria-axis" placeholder="محور ارزیابی">
                <input type="text" id="criteria-indicators" placeholder="شاخص‌ها (با کاما جدا کنید)">
                <button onclick="addCriteria()">ثبت ➕</button>
                <input type="text" class="search-input" id="criteria-search" placeholder="جستجوی معیارها..." oninput="loadCriteria()">
                <div class="table-container">
                    <table id="criteria-table">
                        <thead>
                            <tr>
                                <th>نقش</th>
                                <th>محور ارزیابی</th>
                                <th>شاخص‌ها</th>
                                <th>عملیات</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="report-card" class="section hidden">
                <h3>کارنامه 📝</h3>
                <div class="filter-container">
                    <select id="report-role" onchange="loadReportPeople()">
                        <option value="">انتخاب نقش</option>
                        <option value="مدیر">مدیر</option>
                        <option value="معاون آموزشی">معاون آموزشی</option>
                        <option value="آموزگار">آموزگار</option>
                    </select>
                    <input type="text" id="report-school-name" placeholder="نام مدرسه" oninput="loadReportPeople()">
                    <select id="report-period" onchange="loadReportPeople()">
                        <option value="">انتخاب دوره</option>
                        <option value="اول">اول</option>
                        <option value="دوم">دوم</option>
                    </select>
                    <select id="report-grade" onchange="loadReportPeople()" class="hidden">
                        <option value="">انتخاب پایه</option>
                        <option value="اول">اول</option>
                        <option value="دوم">دوم</option>
                        <option value="سوم">سوم</option>
                        <option value="چهارم">چهارم</option>
                        <option value="پنجم">پنجم</option>
                        <option value="ششم">ششم</option>
                        <option value="سایر">سایر</option>
                    </select>
                    <select id="report-gender" onchange="loadReportPeople()">
                        <option value="">انتخاب جنسیت</option>
                        <option value="دخترانه">دخترانه</option>
                        <option value="پسرانه">پسرانه</option>
                        <option value="مختلط">مختلط</option>
                    </select>
                    <select id="report-type" onchange="loadReportPeople()">
                        <option value="">انتخاب نوع</option>
                        <option value="دولتی">دولتی</option>
                        <option value="غیردولتی">غیردولتی</option>
                    </select>
                    <input type="number" id="report-student-count" placeholder="تعداد دانش‌آموزان" oninput="loadReportPeople()">
                    <select id="report-location" onchange="loadReportPeople()">
                        <option value="">انتخاب موقعیت</option>
                        <option value="شهری">شهری</option>
                        <option value="روستایی">روستایی</option>
                    </select>
                    <select id="report-person" onchange="loadReportCard()" disabled></select>
                </div>
                <input type="text" class="search-input" id="report-search" placeholder="جستجوی فرد..." oninput="searchPerson('report')">
                <div class="table-container">
                    <table id="report-table">
                        <thead>
                            <tr>
                                <th>محور ارزیابی</th>
                                <th>شاخص‌ها</th>
                                <th>امتیاز</th>
                                <th>نظر ارزیاب</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button onclick="saveReportCard()">ذخیره 💾</button>
                <p>جمع کل امتیاز: <span id="total-score">0</span> 🌟</p>
                <p>معدل: <span id="avg-score">0</span> 📈</p>
                <p>مقایسه با میانگین کل: <span id="avg-compare">0</span> ⚖️</p>
                <div class="report-analysis" id="report-analysis"></div>
            </div>

            <div id="summary" class="section hidden">
                <h3>خلاصه گزارش 📊</h3>
                <div class="filter-container">
                    <select id="summary-role" onchange="loadSummaryPeople()">
                        <option value="">انتخاب نقش</option>
                        <option value="مدیر">مدیر</option>
                        <option value="معاون آموزشی">معاون آموزشی</option>
                        <option value="آموزگار">آموزگار</option>
                    </select>
                    <input type="text" id="summary-school-name" placeholder="نام مدرسه" oninput="loadSummaryPeople()">
                    <select id="summary-period" onchange="loadSummaryPeople()">
                        <option value="">انتخاب دوره</option>
                        <option value="اول">اول</option>
                        <option value="دوم">دوم</option>
                    </select>
                    <select id="summary-grade" onchange="loadSummaryPeople()" class="hidden">
                        <option value="">انتخاب پایه</option>
                        <option value="اول">اول</option>
                        <option value="دوم">دوم</option>
                        <option value="سوم">سوم</option>
                        <option value="چهارم">چهارم</option>
                        <option value="پنجم">پنجم</option>
                        <option value="ششم">ششم</option>
                        <option value="سایر">سایر</option>
                    </select>
                    <select id="summary-gender" onchange="loadSummaryPeople()">
                        <option value="">انتخاب جنسیت</option>
                        <option value="دخترانه">دخترانه</option>
                        <option value="پسرانه">پسرانه</option>
                        <option value="مختلط">مختلط</option>
                    </select>
                    <select id="summary-type" onchange="loadSummaryPeople()">
                        <option value="">انتخاب نوع</option>
                        <option value="دولتی">دولتی</option>
                        <option value="غیردولتی">غیردولتی</option>
                    </select>
                    <input type="number" id="summary-student-count" placeholder="تعداد دانش‌آموزان" oninput="loadSummaryPeople()">
                    <select id="summary-location" onchange="loadSummaryPeople()">
                        <option value="">انتخاب موقعیت</option>
                        <option value="شهری">شهری</option>
                        <option value="روستایی">روستایی</option>
                    </select>
                    <select id="summary-person" onchange="loadSummary()" disabled></select>
                </div>
                <input type="text" class="search-input" id="summary-search" placeholder="جستجوی فرد..." oninput="searchPerson('summary')">
                <div id="summary-details"></div>
                <canvas id="bar-chart" class="chart"></canvas>
                <canvas id="line-chart" class="chart"></canvas>
                <div class="table-container">
                    <table id="summary-table" class="analysis-table">
                        <thead>
                            <tr>
                                <th>نام</th>
                                <th>کد پرسنلی</th>
                                <th>معدل</th>
                                <th>نمره ارزشیابی</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="table-container">
                    <table id="analysis-table" class="analysis-table">
                        <thead>
                            <tr>
                                <th>نام</th>
                                <th>معدل</th>
                                <th>وضعیت</th>
                                <th>پیشنهاد</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <button onclick="printSummary()">پرینت گزارش 🖨️</button>
                <button onclick="exportToExcel()">خروجی اکسل 📑</button>
            </div>

            <div id="strategic-analysis" class="section hidden">
                <h3>تحلیل راهبردی 🧠</h3>
                <div id="strategic-report"></div>
            </div>

            <div id="top-performers" class="section hidden">
                <h3>برترین‌ها 🏆</h3>
                <button onclick="printTopPerformers()">چاپ برترین‌ها 🖨️</button>
                <h4>برترین کلی</h4>
                <div class="table-container">
                    <table id="top-all">
                        <thead>
                            <tr>
                                <th>رتبه</th>
                                <th>نام</th>
                                <th>نقش</th>
                                <th>معدل</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <h4>برترین روستا</h4>
                <div class="table-container">
                    <table id="top-rural">
                        <thead>
                            <tr>
                                <th>رتبه</th>
                                <th>نام</th>
                                <th>نقش</th>
                                <th>معدل</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <h4>برترین شهر</h4>
                <div class="table-container">
                    <table id="top-urban">
                        <thead>
                            <tr>
                                <th>رتبه</th>
                                <th>نام</th>
                                <th>نقش</th>
                                <th>معدل</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <h4>برترین دخترانه</h4>
                <div class="table-container">
                    <table id="top-girls">
                        <thead>
                            <tr>
                                <th>رتبه</th>
                                <th>نام</th>
                                <th>نقش</th>
                                <th>معدل</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <h4>برترین پسرانه</h4>
                <div class="table-container">
                    <table id="top-boys">
                        <thead>
                            <tr>
                                <th>رتبه</th>
                                <th>نام</th>
                                <th>نقش</th>
                                <th>معدل</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        <footer>سازنده: حسین هادی پور 🔨</footer>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // Polyfills for older browsers
        if (!window.Promise) {
            window.Promise = function(executor) {
                let resolve, reject;
                const promise = {
                    then: (onFulfilled) => {
                        resolve = onFulfilled;
                        return promise;
                    },
                    catch: (onRejected) => {
                        reject = onRejected;
                        return promise;
                    }
                };
                executor(value => resolve && resolve(value), reason => reject && reject(reason));
                return promise;
            };
        }
        if (!Array.prototype.flatMap) {
            Array.prototype.flatMap = function(callback) {
                return Array.prototype.concat.apply([], this.map(callback));
            };
        }

        // Initialize Data
        let credentials = { username: '1', password: '1' };
        let people = [];
        let reportCards = [];
        let criteria = {
            'مدیر': [
                { axis: 'رهبری', indicators: ['تصمیم‌گیری', 'انگیزه‌بخشی', 'مدیریت تیم'] }
            ],
            'معاون آموزشی': [
                { axis: 'مدیریت آموزشی', indicators: ['برنامه‌ریزی درسی', 'نظارت بر معلمان', 'ارزیابی دانش‌آموزان'] }
            ],
            'آموزگار': [
                { axis: 'تدریس', indicators: ['کیفیت درس', 'تعامل با دانش‌آموزان', 'ارزیابی'] }
            ]
        };
        try {
            const storedCredentials = localStorage.getItem('credentials_school_staff');
            if (storedCredentials) credentials = JSON.parse(storedCredentials);
            const storedPeople = localStorage.getItem('people_school_staff');
            if (storedPeople) people = JSON.parse(storedPeople);
            const storedReportCards = localStorage.getItem('reportCards_school_staff');
            if (storedReportCards) reportCards = JSON.parse(storedReportCards);
            const storedCriteria = localStorage.getItem('criteria_school_staff');
            if (storedCriteria) criteria = JSON.parse(storedCriteria);
        } catch (e) {
            console.error('Error parsing localStorage data:', e);
            localStorage.clear();
            localStorage.setItem('credentials_school_staff', JSON.stringify(credentials));
            localStorage.setItem('criteria_school_staff', JSON.stringify(criteria));
            Swal.fire({
                title: 'خطا',
                text: 'خطا در بارگذاری داده‌ها. داده‌ها بازنشانی شدند.',
                icon: 'error',
                confirmButtonText: 'باشه',
                confirmButtonColor: '#A5B4FC'
            });
        }

        // Hamburger Menu
        function toggleMenu() {
            const navMenu = document.getElementById('nav-menu');
            const dashMenu = document.getElementById('dashboard-menu');
            navMenu.classList.toggle('active');
            dashMenu.classList.toggle('active');
        }

        // Show Section
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => section.classList.add('hidden'));
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.remove('hidden');
                if (sectionId === 'strategic-analysis') {
                    generateStrategicAnalysis();
                } else if (sectionId === 'top-performers') {
                    loadTopPerformers();
                }
                Swal.fire({
                    title: 'بخش باز شد',
                    text: `بخش ${section.querySelector('h3').textContent} با موفقیت باز شد!`,
                    icon: 'info',
                    timer: 1500,
                    showConfirmButton: false
                });
            } else {
                console.error(`Section ${sectionId} not found`);
                Swal.fire({
                    title: 'خطا',
                    text: `بخش ${sectionId} یافت نشد!`,
                    icon: 'error',
                    confirmButtonText: 'باشه',
                    confirmButtonColor: '#A5B4FC'
                });
            }
        }

        // Login
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (username === credentials.username && password === credentials.password) {
                document.getElementById('login-container').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                updateStats();
                loadCriteria();
                Swal.fire({
                    title: 'ورود موفق',
                    text: 'خوش آمدید! 😊',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
            } else {
                Swal.fire({
                    title: 'خطا',
                    text: 'نام کاربری یا رمز عبور اشتباه است! 😕',
                    icon: 'error',
                    confirmButtonText: 'باشه',
                    confirmButtonColor: '#A5B4FC'
                });
            }
        }

        // Change Password
        function changePassword() {
            const newPassword = document.getElementById('new-password').value;
            if (newPassword) {
                credentials.password = newPassword;
                localStorage.setItem('credentials_school_staff', JSON.stringify(credentials));
                Swal.fire({
                    title: 'موفقیت',
                    text: 'رمز با موفقیت تغییر کرد! 🔑',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                });
            } else {
                Swal.fire({
                    title: 'هشدار',
                    text: 'لطفاً رمز جدید را وارد کنید! ⚠️',
                    icon: 'warning',
                    timer: 1500,
                    showConfirmButton: false
                });
            }
        }

        // JSON Export
        function exportToJSON() {
            const data = {
                credentials,
                people,
                reportCards,
                criteria
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'school_staff_data.json';
            link.click();
            URL.revokeObjectURL(url);
            Swal.fire({
                title: 'موفقیت',
                text: 'فایل JSON با موفقیت دانلود شد! 📤',
                icon: 'success',
                timer: 1500,
                showConfirmButton: false
            });
        }

        // JSON Import
        function importFromJSON(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.credentials) {
                        credentials = { ...credentials, ...importedData.credentials };
                        localStorage.setItem('credentials_school_staff', JSON.stringify(credentials));
                    }
                    if (importedData.people) {
                        importedData.people.forEach(newPerson => {
                            const existingIndex = people.findIndex(p => p.personnelCode === newPerson.personnelCode);
                            if (existingIndex >= 0) {
                                people[existingIndex] = { ...people[existingIndex], ...newPerson };
                            } else {
                                people.push(newPerson);
                            }
                        });
                        localStorage.setItem('people_school_staff', JSON.stringify(people));
                    }
                    if (importedData.reportCards) {
                        importedData.reportCards.forEach(newReport => {
                            const existingIndex = reportCards.findIndex(r => r.key === newReport.key);
                            if (existingIndex >= 0) {
                                reportCards[existingIndex] = { ...reportCards[existingIndex], ...newReport };
                            } else {
                                reportCards.push(newReport);
                            }
                        });
                        localStorage.setItem('reportCards_school_staff', JSON.stringify(reportCards));
                    }
                    if (importedData.criteria) {
                        for (const role in importedData.criteria) {
                            if (!criteria[role]) criteria[role] = [];
                            criteria[role] = [...criteria[role], ...importedData.criteria[role]];
                        }
                        localStorage.setItem('criteria_school_staff', JSON.stringify(criteria));
                    }
                    filterPeople();
                    updateStats();
                    loadCriteria();
                    loadSummary();
                    Swal.fire({
                        title: 'موفقیت',
                        text: 'داده‌ها با موفقیت وارد شدند! 📥',
                        icon: 'success',
                        timer: 1500,
                        showConfirmButton: false
                    });
                } catch (err) {
                    console.error('Error importing JSON:', err);
                    Swal.fire({
                        title: 'خطا',
                        text: 'خطا در وارد کردن فایل JSON! لطفاً فایل معتبر انتخاب کنید.',
                        icon: 'error',
                        timer: 1500,
                        showConfirmButton: false
                    });
                }
            };
            reader.readAsText(file);
        }

        // Excel Import
        function importFromExcel(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = e.target.result;
                    const workbook = XLSX.read(data, { type: 'binary' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                    json.shift();
                    json.forEach(row => {
                        if (row.length < 12) return;
                        const personnelCode = row[0].toString();
                        const schoolCode = row[1].toString();
                        const schoolName = row[2];
                        const genderSchool = row[3];
                        const shift = row[4];
                        const location = row[5];
                        const period = row[6];
                        const schoolType = row[7];
                        const name = row[8];
                        const familyName = row[9];
                        const fullName = `${name} ${familyName}`;
                        const nationalCode = row[10].toString();
                        const gender = row[11];
                        const role = row[12];
                        const grade = row[13];
                        const status = row[14];
                        const hours = row[15];
                        const temporaryOrPermanent = row[16];
                        const ablaghType = row[17];
                        const phone = row[18].toString();
                        const description = row[19];
                        const ablaghDescription = row[20];
                        const entryExit = row[21];
                        const newPerson = {
                            name: fullName,
                            personnelCode,
                            nationalCode,
                            role,
                            schoolName,
                            period,
                            grade,
                            gender: genderSchool,
                            type: schoolType,
                            studentCount: '', // add if available
                            location,
                            phone,
                            active: status === 'شاغل'
                        };
                        const existingIndex = people.findIndex(p => p.personnelCode === personnelCode);
                        if (existingIndex >= 0) {
                            people[existingIndex] = { ...people[existingIndex], ...newPerson };
                        } else {
                            people.push(newPerson);
                        }
                    });
                    localStorage.setItem('people_school_staff', JSON.stringify(people));
                    filterPeople();
                    updateStats();
                    loadSummary();
                    Swal.fire({
                        title: 'موفقیت',
                        text: 'همه پرسنل از اکسل وارد شدند! 📥',
                        icon: 'success',
                        animation: true,
                        timer: 1500,
                        showConfirmButton: false,
                        customClass: {
                            icon: 'animated-icon'
                        }
                    });
                } catch (err) {
                    console.error('Error importing Excel:', err);
                    Swal.fire({
                        title: 'خطا',
                        text: 'خطا در وارد کردن فایل اکسل!',
                        icon: 'error',
                        animation: true,
                        timer: 1500,
                        showConfirmButton: false,
                        customClass: {
                            icon: 'animated-icon'
                        }
                    });
                }
            };
            reader.readAsBinaryString(file);
        }

        // Update Stats
        function updateStats() {
            document.getElementById('total-people').textContent = people.filter(p => p.active).length;
            document.getElementById('avg-grade').textContent = calculateOverallAverage();
        }

        // People Management
        function addPerson() {
            const name = document.getElementById('person-name').value;
            const personnelCode = document.getElementById('person-personnel-code').value;
            const nationalCode = document.getElementById('person-national-code').value;
            const role = document.getElementById('person-role').value;
            const schoolName = document.getElementById('person-school-name').value;
            const period = document.getElementById('person-period').value;
            const grade = document.getElementById('person-grade').value;
            const gender = document.getElementById('person-gender').value;
            const type = document.getElementById('person-type').value;
            const studentCount = document.getElementById('person-student-count').value;
            const location = document.getElementById('person-location').value;
            if (!name || !personnelCode || !nationalCode || !role || !schoolName || !period || !gender || !type || !studentCount || !location) {
                Swal.fire({
                    title: 'هشدار',
                    text: 'لطفاً تمام فیلدهای الزامی را پر کنید! ⚠️',
                    icon: 'warning',
                    confirmButtonText: 'باشه',
                    confirmButtonColor: '#A5B4FC',
                    animation: true,
                    customClass: {
                        icon: 'animated-icon'
                    }
                });
                return;
            }
            if (role === 'آموزگار' && !grade) {
                Swal.fire({
                    title: 'هشدار',
                    text: 'برای آموزگار پایه را انتخاب کنید! ⚠️',
                    icon: 'warning',
                    confirmButtonText: 'باشه',
                    confirmButtonColor: '#A5B4FC',
                    animation: true,
                    customClass: {
                        icon: 'animated-icon'
                    }
                });
                return;
            }
            if (people.some(p => p.personnelCode === personnelCode && p.active)) {
                Swal.fire({
                    title: 'هشدار',
                    text: 'این کد پرسنلی قبلاً ثبت شده است! 🚫',
                    icon: 'warning',
                    confirmButtonText: 'باشه',
                    confirmButtonColor: '#A5B4FC',
                    animation: true,
                    customClass: {
                        icon: 'animated-icon'
                    }
                });
                return;
            }
            people.push({ name, personnelCode, nationalCode, role, schoolName, period, grade, gender, type, studentCount, location, active: true });
            localStorage.setItem('people_school_staff', JSON.stringify(people));
            filterPeople();
            updateStats();
            Swal.fire({
                title: 'موفقیت',
                text: 'فرد با موفقیت ثبت شد! ✅',
                icon: 'success',
                confirmButtonText: 'باشه',
                confirmButtonColor: '#A5B4FC',
                animation: true,
                customClass: {
                    icon: 'animated-icon'
                }
            });
            document.querySelectorAll('#people input, #people select').forEach(input => input.value = '');
        }
        function filterPeople() {
            const filter = document.getElementById('person-filter').value;
            const search = document.getElementById('people-search').value.toLowerCase();
            const tbody = document.querySelector('#people-table tbody');
            tbody.innerHTML = '';
            people.forEach((person, index) => {
                if ((filter === 'all' || (filter === 'active' && person.active) || (filter === 'inactive' && !person.active)) &&
                    (!search || person.name.toLowerCase().includes(search) || person.personnelCode.toLowerCase().includes(search))) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${person.name}</td>
                        <td>${person.personnelCode}</td>
                        <td>${person.nationalCode}</td>
                        <td>${person.role}</td>
                        <td>${person.schoolName}</td>
                        <td>${person.period}</td>
                        <td>${person.grade || '-'}</td>
                        <td>${person.gender}</td>
                        <td>${person.type}</td>
                        <td>${person.studentCount}</td>
                        <td>${person.location}</td>
                        <td>${person.active ? 'فعال ✅' : 'غیرفعال 🚫'}</td>
                        <td>
                            <button onclick="editPerson(${index})">ویرایش ✏️</button>
                            <button onclick="deletePerson(${index})">حذف 🗑️</button>
                            <button onclick="togglePersonStatus(${index})">${person.active ? 'غیرفعال 🚫' : 'فعال ✅'}</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            });
        }
        function editPerson(index) {
            const person = people[index];
            document.getElementById('person-name').value = person.name;
            document.getElementById('person-personnel-code').value = person.personnelCode;
            document.getElementById('person-national-code').value = person.nationalCode;
            document.getElementById('person-role').value = person.role;
            document.getElementById('person-school-name').value = person.schoolName;
            document.getElementById('person-period').value = person.period;
            document.getElementById('person-grade').value = person.grade || '';
            document.getElementById('person-gender').value = person.gender;
            document.getElementById('person-type').value = person.type;
            document.getElementById('person-student-count').value = person.studentCount;
            document.getElementById('person-location').value = person.location;
            deletePerson(index);
        }
        function deletePerson(index) {
            people.splice(index, 1);
            localStorage.setItem('people_school_staff', JSON.stringify(people));
            filterPeople();
            updateStats();
        }
        function togglePersonStatus(index) {
            people[index].active = !people[index].active;
            localStorage.setItem('people_school_staff', JSON.stringify(people));
            filterPeople();
            updateStats();
        }
        function clearAllPeople() {
            Swal.fire({
                title: 'هشدار',
                text: 'آیا مطمئن هستید که می‌خواهید همه افراد را حذف کنید؟',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'بله، حذف کن',
                cancelButtonText: 'لغو'
            }).then((result) => {
                if (result.isConfirmed) {
                    people = [];
                    localStorage.setItem('people_school_staff', JSON.stringify(people));
                    filterPeople();
                    updateStats();
                    Swal.fire({
                        title: 'موفقیت',
                        text: 'همه افراد حذف شدند!',
                        icon: 'success'
                    });
                }
            });
        }

        // Criteria Management
        function addCriteria() {
            const role = document.getElementById('criteria-role').value;
            const axis = document.getElementById('criteria-axis').value;
            const indicators = document.getElementById('criteria-indicators').value.split(',').map(i => i.trim());
            if (!role || !axis || indicators.length === 0 || indicators[0] === '') {
                Swal.fire({
                    title: 'هشدار',
                    text: 'لطفاً نقش، محور و حداقل یک شاخص وارد کنید! ⚠️',
                    icon: 'warning',
                    confirmButtonText: 'باشه',
                    confirmButtonColor: '#A5B4FC',
                    animation: true,
                    customClass: {
                        icon: 'animated-icon'
                    }
                });
                return;
            }
            if (!criteria[role]) criteria[role] = [];
            criteria[role].push({ axis, indicators });
            localStorage.setItem('criteria_school_staff', JSON.stringify(criteria));
            loadCriteria();
            document.getElementById('criteria-axis').value = '';
            document.getElementById('criteria-indicators').value = '';
            Swal.fire({
                title: 'موفقیت',
                text: 'معیار با موفقیت ثبت شد! ✅',
                icon: 'success',
                confirmButtonText: 'باشه',
                confirmButtonColor: '#A5B4FC',
                animation: true,
                customClass: {
                    icon: 'animated-icon'
                }
            });
        }
        function loadCriteria() {
            const search = document.getElementById('criteria-search').value.toLowerCase();
            const tbody = document.querySelector('#criteria-table tbody');
            tbody.innerHTML = '';
            for (const role in criteria) {
                criteria[role].forEach((c, index) => {
                    if (!search || role.toLowerCase().includes(search) || c.axis.toLowerCase().includes(search) || c.indicators.some(i => i.toLowerCase().includes(search))) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${role}</td>
                            <td>${c.axis}</td>
                            <td>${c.indicators.join(', ')}</td>
                            <td>
                                <button onclick="editCriteria('${role}', ${index})">ویرایش ✏️</button>
                                <button onclick="deleteCriteria('${role}', ${index})">حذف 🗑️</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    }
                });
            }
        }
        function editCriteria(role, index) {
            const crit = criteria[role][index];
            document.getElementById('criteria-role').value = role;
            document.getElementById('criteria-axis').value = crit.axis;
            document.getElementById('criteria-indicators').value = crit.indicators.join(', ');
            criteria[role].splice(index, 1);
            localStorage.setItem('criteria_school_staff', JSON.stringify(criteria));
            loadCriteria();
        }
        function deleteCriteria(role, index) {
            criteria[role].splice(index, 1);
            localStorage.setItem('criteria_school_staff', JSON.stringify(criteria));
            loadCriteria();
        }

        // Advanced Filtering
        function filterPeopleByCriteria(section) {
            const role = document.getElementById(`${section}-role`).value;
            const schoolName = document.getElementById(`${section}-school-name`).value.toLowerCase();
            const period = document.getElementById(`${section}-period`).value;
            const grade = document.getElementById(`${section}-grade`).value;
            const gender = document.getElementById(`${section}-gender`).value;
            const type = document.getElementById(`${section}-type`).value;
            const studentCount = document.getElementById(`${section}-student-count`).value;
            const location = document.getElementById(`${section}-location`).value;

            return people.filter(p => {
                return p.active &&
                    (!role || p.role === role) &&
                    (!schoolName || p.schoolName.toLowerCase().includes(schoolName)) &&
                    (!period || p.period === period) &&
                    (!grade || p.grade === grade || p.role !== 'آموزگار') &&
                    (!gender || p.gender === gender) &&
                    (!type || p.type === type) &&
                    (!studentCount || p.studentCount == studentCount) &&
                    (!location || p.location === location);
            });
        }

        // Load People for Report/Summary
        function loadReportPeople() {
            const personSelect = document.getElementById('report-person');
            const gradeSelect = document.getElementById('report-grade');
            const role = document.getElementById('report-role').value;
            personSelect.disabled = !role;
            personSelect.innerHTML = '<option value="">انتخاب فرد</option>';
            const filteredPeople = filterPeopleByCriteria('report');
            filteredPeople.forEach(p => {
                const option = document.createElement('option');
                option.value = p.name;
                option.text = p.name;
                personSelect.appendChild(option);
            });
            if (role === 'آموزگار') {
                gradeSelect.classList.remove('hidden');
            } else {
                gradeSelect.classList.add('hidden');
                gradeSelect.value = '';
            }
            loadReportCard();
        }
        function loadSummaryPeople() {
            const personSelect = document.getElementById('summary-person');
            const gradeSelect = document.getElementById('summary-grade');
            const role = document.getElementById('summary-role').value;
            personSelect.disabled = !role;
            personSelect.innerHTML = '<option value="all">همه</option>';
            const filteredPeople = filterPeopleByCriteria('summary');
            filteredPeople.forEach(p => {
                const option = document.createElement('option');
                option.value = p.name;
                option.text = p.name;
                personSelect.appendChild(option);
            });
            if (role === 'آموزگار') {
                gradeSelect.classList.remove('hidden');
            } else {
                gradeSelect.classList.add('hidden');
                gradeSelect.value = '';
            }
            loadSummary();
        }

        // Report Card Management
        function loadReportCard() {
            const role = document.getElementById('report-role').value;
            const person = document.getElementById('report-person').value;
            const grade = document.getElementById('report-grade').value;
            const tbody = document.querySelector('#report-table tbody');
            tbody.innerHTML = '';
            if (!role || !person || (role === 'آموزگار' && !grade)) return;
            const reportKey = `${role}_${person}_${role === 'آموزگار' ? grade : ''}`;
            const report = reportCards.find(r => r.key === reportKey) || { scores: {}, comments: {} };
            const roleCriteria = criteria[role] || [];
            roleCriteria.forEach(c => {
                c.indicators.forEach(ind => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${c.axis}</td>
                        <td>${ind}</td>
                        <td>
                            <input type="radio" name="${c.axis}-${ind}" value="2" ${report.scores[`${c.axis}-${ind}`] === 2 ? 'checked' : ''}> 2
                            <input type="radio" name="${c.axis}-${ind}" value="4" ${report.scores[`${c.axis}-${ind}`] === 4 ? 'checked' : ''}> 4
                            <input type="radio" name="${c.axis}-${ind}" value="6" ${report.scores[`${c.axis}-${ind}`] === 6 ? 'checked' : ''}> 6
                            <input type="radio" name="${c.axis}-${ind}" value="8" ${report.scores[`${c.axis}-${ind}`] === 8 ? 'checked' : ''}> 8
                            <input type="radio" name="${c.axis}-${ind}" value="10" ${report.scores[`${c.axis}-${ind}`] === 10 ? 'checked' : ''}> 10
                        </td>
                        <td><textarea>${report.comments[`${c.axis}-${ind}`] || ''}</textarea></td>
                    `;
                    tbody.appendChild(row);
                });
            });
            updateReportStats(reportKey);
            analyzeReport(reportKey);
        }
        function analyzeReport(reportKey) {
            const report = reportCards.find(r => r.key === reportKey) || { scores: {}, comments: {}, role: '' };
            const positiveWords = ['عالی', 'خوب', 'قوی', 'انگیزه', 'موفق', 'بهبود یافته', 'مثبت'];
            const negativeWords = ['ضعیف', 'نیاز به بهبود', 'کم', 'مشکل', 'منفی', 'کاهش'];
            let positiveCount = 0, negativeCount = 0;
            let totalScore = 0, count = 0;
            let analysis = '<h4>تحلیل عملکرد</h4>';
            analysis += '<p>تحلیل نمرات: </p>';
            (criteria[report.role] || []).forEach(c => {
                let axisTotal = 0, axisCount = 0;
                c.indicators.forEach(ind => {
                    const score = report.scores[`${c.axis}-${ind}`] || 0;
                    axisTotal += score;
                    axisCount++;
                    totalScore += score;
                    count++;
                    const comment = report.comments[`${c.axis}-${ind}`] || '';
                    positiveWords.forEach(word => {
                        if (comment.includes(word)) positiveCount++;
                    });
                    negativeWords.forEach(word => {
                        if (comment.includes(word)) negativeCount++;
                    });
                });
                const axisAvg = axisCount ? (axisTotal / axisCount).toFixed(2) : 0;
                analysis += `<p>محور ${c.axis}: میانگین ${axisAvg} - ${axisAvg >= 8 ? 'عالی' : axisAvg >= 5 ? 'متوسط' : 'نیاز به بهبود'}</p>`;
            });
            const avg = count ? (totalScore / count).toFixed(2) : 0;
            const sentiment = positiveCount > negativeCount ? 'مثبت (انگیزه بالا)' : negativeCount > positiveCount ? 'منفی (نیاز به پشتیبانی)' : 'متعادل';
            analysis += `<p>تحلیل روانشناختی: ${sentiment}</p>`;
            analysis += `<p>پیشنهاد: ${avg >= 8 ? 'ادامه عملکرد عالی و تشویق' : avg >= 5 ? 'تمرکز بر بهبود نقاط ضعف' : 'دوره آموزشی و نظارت بیشتر'}</p>`;
            analysis += `<p>قضاوت بر اساس نقش (${report.role}): ${report.role === 'مدیر' ? 'رهبری قوی مورد نیاز است' : report.role === 'معاون آموزشی' ? 'تمرکز بر برنامه‌ریزی' : 'بهبود تعامل با دانش‌آموزان'}</p>`;
            analysis += `<p>اطلاعات تصمیم‌گیری: معدل ${avg}, نظرات مثبت: ${positiveCount}, نظرات منفی: ${negativeCount}</p>`;
            document.getElementById('report-analysis').innerHTML = analysis;
        }
        function saveReportCard() {
            const role = document.getElementById('report-role').value;
            const person = document.getElementById('report-person').value;
            const grade = document.getElementById('report-grade').value;
            if (!role || !person || (role === 'آموزگار' && !grade)) {
                Swal.fire({
                    title: 'هشدار',
                    text: 'لطفاً نقش، فرد و برای آموزگار پایه را انتخاب کنید! ⚠️',
                    icon: 'warning',
                    confirmButtonText: 'باشه',
                    confirmButtonColor: '#A5B4FC',
                    animation: true,
                    customClass: {
                        icon: 'animated-icon'
                    }
                });
                return;
            }
            const reportKey = `${role}_${person}_${role === 'آموزگار' ? grade : ''}`;
            const scores = {};
            const comments = {};
            const roleCriteria = criteria[role] || [];
            roleCriteria.forEach(c => {
                c.indicators.forEach(ind => {
                    const score = document.querySelector(`input[name="${c.axis}-${ind}"]:checked`);
                    scores[`${c.axis}-${ind}`] = score ? parseInt(score.value) : 0;
                    const textarea = Array.from(document.querySelectorAll(`#report-table textarea`)).find(ta => ta.closest('tr').querySelector(`input[name="${c.axis}-${ind}"]`));
                    comments[`${c.axis}-${ind}`] = textarea ? textarea.value : '';
                });
            });
            const reportIndex = reportCards.findIndex(r => r.key === reportKey);
            const report = { key: reportKey, role, person, grade, scores, comments };
            if (reportIndex >= 0) {
                reportCards[reportIndex] = report;
            } else {
                reportCards.push(report);
            }
            localStorage.setItem('reportCards_school_staff', JSON.stringify(reportCards));
            updateReportStats(reportKey);
            analyzeReport(reportKey);
            updateStats();
            loadSummary();
            Swal.fire({
                title: 'موفقیت',
                text: 'کارنامه ذخیره شد! 💾',
                icon: 'success',
                confirmButtonText: 'باشه',
                confirmButtonColor: '#A5B4FC',
                animation: true,
                customClass: {
                    icon: 'animated-icon'
                }
            });
        }
        function updateReportStats(reportKey) {
            const report = reportCards.find(r => r.key === reportKey) || { scores: {} };
            let total = 0, count = 0;
            for (const key in report.scores) {
                total += report.scores[key];
                if (report.scores[key] > 0) count++;
            }
            const avg = count ? (total / count).toFixed(2) : 0;
            const overallAvg = calculateOverallAverage();
            document.getElementById('total-score').textContent = total;
            document.getElementById('avg-score').textContent = avg;
            document.getElementById('avg-compare').textContent = (avg - overallAvg).toFixed(2);
        }
        function calculateOverallAverage() {
            let total = 0, count = 0;
            reportCards.forEach(r => {
                for (const key in r.scores) {
                    total += r.scores[key];
                    if (r.scores[key] > 0) count++;
                }
            });
            return count ? (total / count).toFixed(2) : 0;
        }

        // Summary Management
        let barChart, lineChart;
        function loadSummary() {
            const role = document.getElementById('summary-role').value;
            const person = document.getElementById('summary-person').value;
            const grade = document.getElementById('summary-grade').value;
            const details = document.getElementById('summary-details');
            const tbody = document.querySelector('#summary-table tbody');
            const analysisTbody = document.querySelector('#analysis-table tbody');
            details.innerHTML = '';
            tbody.innerHTML = '';
            analysisTbody.innerHTML = '';
            if (barChart) barChart.destroy();
            if (lineChart) lineChart.destroy();

            if (person && person !== 'all') {
                const personData = people.find(p => p.name === person && p.role === role);
                if (!personData) return;
                const reportKey = `${role}_${person}_${role === 'آموزگار' ? grade : ''}`;
                const report = reportCards.find(r => r.key === reportKey) || { scores: {}, comments: {} };
                let total = 0, count = 0;
                for (const key in report.scores) {
                    total += report.scores[key];
                    if (report.scores[key] > 0) count++;
                }
                const avg = count ? (total / count).toFixed(2) : 0;
                const barData = [{ name: person, avg: parseFloat(avg) }];
                const lineData = (criteria[role] || []).map(c => {
                    let axisTotal = 0, axisCount = 0;
                    c.indicators.forEach(ind => {
                        const score = report.scores[`${c.axis}-${ind}`] || 0;
                        axisTotal += score;
                        if (score > 0) axisCount++;
                    });
                    return axisCount ? (axisTotal / axisCount).toFixed(2) : 0;
                });
                details.innerHTML = `
                    <div class="person-details">
                        <h4>جزئیات ${person} 👤</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>نام</th>
                                        <th>کد پرسنلی</th>
                                        <th>کد ملی</th>
                                        <th>نقش</th>
                                        <th>نام مدرسه</th>
                                        <th>دوره</th>
                                        <th>پایه</th>
                                        <th>جنسیت</th>
                                        <th>نوع</th>
                                        <th>تعداد دانش‌آموزان</th>
                                        <th>موقعیت</th>
                                        <th>معدل</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>${personData.name}</td>
                                        <td>${personData.personnelCode}</td>
                                        <td>${personData.nationalCode}</td>
                                        <td>${personData.role}</td>
                                        <td>${personData.schoolName}</td>
                                        <td>${personData.period}</td>
                                        <td>${personData.grade || '-'}</td>
                                        <td>${personData.gender}</td>
                                        <td>${personData.type}</td>
                                        <td>${personData.studentCount}</td>
                                        <td>${personData.location}</td>
                                        <td>${avg}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <h4>کارنامه 📝</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>محور ارزیابی</th>
                                        <th>شاخص‌ها</th>
                                        <th>امتیاز</th>
                                        <th>نظر ارزیاب</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(criteria[role] || []).flatMap(c => 
                                        c.indicators.map(ind => `
                                            <tr>
                                                <td>${c.axis}</td>
                                                <td>${ind}</td>
                                                <td>${report.scores[`${c.axis}-${ind}`] || 0}</td>
                                                <td>${report.comments[`${c.axis}-${ind}`] || '-'}</td>
                                            </tr>
                                        `)).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                // Analysis for single person
                const analysisRow = document.createElement('tr');
                const status = avg >= 8 ? 'عالی' : avg >= 5 ? 'متوسط' : 'نیاز به بهبود';
                const recommendation = avg >= 8 ? 'تشویقی' : avg >= 5 ? 'اخطار' : 'توبیخ';
                analysisRow.innerHTML = `
                    <td>${personData.name}</td>
                    <td>${avg}</td>
                    <td>${status}</td>
                    <td>${recommendation}</td>
                `;
                analysisTbody.appendChild(analysisRow);
                if (window.Chart) {
                    barChart = new Chart(document.getElementById('bar-chart'), {
                        type: 'bar',
                        data: {
                            labels: barData.map(d => d.name),
                            datasets: [{
                                label: 'معدل',
                                data: barData.map(d => d.avg),
                                backgroundColor: '#A5B4FC'
                            }]
                        }
                    });
                    lineChart = new Chart(document.getElementById('line-chart'), {
                        type: 'line',
                        data: {
                            labels: (criteria[role] || []).map(c => c.axis),
                            datasets: [{
                                label: `میانگین محورهای ${person}`,
                                data: lineData,
                                borderColor: '#A5B4FC'
                            }]
                        }
                    });
                }
            } else {
                const filteredPeople = filterPeopleByCriteria('summary');
                filteredPeople.sort((a, b) => {
                    if (a.role === 'آموزگار' && b.role === 'آموزگار') {
                        const grades = ['اول', 'دوم', 'سوم', 'چهارم', 'پنجم', 'ششم', 'سایر'];
                        return grades.indexOf(a.grade) - grades.indexOf(b.grade);
                    }
                    return a.role.localeCompare(b.role);
                });
                filteredPeople.forEach(p => {
                    const reportKey = `${p.role}_${p.name}_${p.role === 'آموزگار' ? p.grade : ''}`;
                    const report = reportCards.find(r => r.key === reportKey) || { scores: {} };
                    let total = 0, count = 0;
                    for (const key in report.scores) {
                        total += report.scores[key];
                        if (report.scores[key] > 0) count++;
                    }
                    const avg = count ? (total / count).toFixed(2) : 0;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${p.name}</td>
                        <td>${p.personnelCode}</td>
                        <td>${avg}</td>
                        <td>${total}</td>
                    `;
                    tbody.appendChild(row);
                    // Analysis for all people
                    const analysisRow = document.createElement('tr');
                    const status = avg >= 8 ? 'عالی' : avg >= 5 ? 'متوسط' : 'نیاز به بهبود';
                    const recommendation = avg >= 8 ? 'تشویقی' : avg >= 5 ? 'اخطار' : 'توبیخ';
                    analysisRow.innerHTML = `
                        <td>${p.name}</td>
                        <td>${avg}</td>
                        <td>${status}</td>
                        <td>${recommendation}</td>
                    `;
                    analysisTbody.appendChild(analysisRow);
                });
                if (window.Chart) {
                    barChart = new Chart(document.getElementById('bar-chart'), {
                        type: 'bar',
                        data: {
                            labels: filteredPeople.map(p => p.name),
                            datasets: [{
                                label: 'معدل',
                                data: filteredPeople.map(p => {
                                    const reportKey = `${p.role}_${p.name}_${p.role === 'آموزگار' ? p.grade : ''}`;
                                    const report = reportCards.find(r => r.key === reportKey) || { scores: {} };
                                    let total = 0, count = 0;
                                    for (const key in report.scores) {
                                        total += report.scores[key];
                                        if (report.scores[key] > 0) count++;
                                    }
                                    return count ? (total / count).toFixed(2) : 0;
                                }),
                                backgroundColor: '#A5B4FC'
                            }]
                        }
                    });
                    lineChart = new Chart(document.getElementById('line-chart'), {
                        type: 'line',
                        data: {
                            labels: filteredPeople.map(p => p.name),
                            datasets: [{
                                label: 'معدل',
                                data: filteredPeople.map(p => {
                                    const reportKey = `${p.role}_${p.name}_${p.role === 'آموزگار' ? p.grade : ''}`;
                                    const report = reportCards.find(r => r.key === reportKey) || { scores: {} };
                                    let total = 0, count = 0;
                                    for (const key in report.scores) {
                                        total += report.scores[key];
                                        if (report.scores[key] > 0) count++;
                                    }
                                    return count ? (total / count).toFixed(2) : 0;
                                }),
                                borderColor: '#A5B4FC'
                            }]
                        }
                    });
                }
            }
        }

        // Strategic Analysis
        function generateStrategicAnalysis() {
            const report = document.getElementById('strategic-report');
            report.innerHTML = '';
            const overallAvg = calculateOverallAverage();
            const lowPerformers = people.filter(p => getAvg(p) < 5).length;
            const mediumPerformers = people.filter(p => getAvg(p) >= 5 && getAvg(p) < 8).length;
            const highPerformers = people.filter(p => getAvg(p) >= 8).length;
            const crisis = overallAvg < 5 || lowPerformers > people.length * 0.3;
            let analysis = '<p>تحلیل راهبردی سیستم:</p>';
            analysis += `<p>میانگین کلی: ${overallAvg} - تعداد عالی: ${highPerformers}, متوسط: ${mediumPerformers}, ضعیف: ${lowPerformers}</p>`;
            if (crisis) {
                analysis += '<p>وضعیت بحرانی: میانگین پایین و تعداد افراد ضعیف زیاد. راهکار: برنامه آموزشی فوری، نظارت بیشتر, حمایت روانشناختی، بررسی علل ریشه‌ای مثل کمبود منابع یا استرس, و جلسات مشاوره برای خروج از بحران. اولویت: تمرکز روی افراد ضعیف برای بهبود سریع.</p>';
            } else if (overallAvg < 8) {
                analysis += '<p>نیاز به بهبود: میانگین متوسط. راهبرد: کارگاه‌های آموزشی هدفمند, برنامه انگیزشی مثل پاداش, ارزیابی عملکرد دوره‌ای, و همکاری بین نقش‌ها برای ارتقا کلی. پیشنهاد: سرمایه‌گذاری روی توسعه مدیران برای رهبری بهتر.</p>';
            } else {
                analysis += '<p>عملکرد عالی: ادامه برنامه‌های فعلی با تمرکز روی حفظ سطح بالا. راهکار: برنامه‌های تشویقی, به اشتراک‌گذاری تجربیات برترین‌ها, و سرمایه‌گذاری روی نوآوری برای پیشرفت بیشتر.</p>';
            }
            analysis += '<p>برنامه پیشنهادی کلی: ارزیابی ماهانه, کارگاه‌های روانشناختی برای مدیریت استرس, بودجه برای تجهیزات آموزشی, و نظارت بر نقش‌ها (مدیران: رهبری, معاونان: برنامه‌ریزی, آموزگاران: تعامل).</p>';
            report.innerHTML = analysis;
        }

        // Top Performers
        function loadTopPerformers() {
            const allTeachers = people.filter(p => p.role === 'آموزگار' && p.active).sort((a, b) => getAvg(b) - getAvg(a)).slice(0, 20);
            const allDeputies = people.filter(p => p.role === 'معاون آموزشی' && p.active).sort((a, b) => getAvg(b) - getAvg(a)).slice(0, 3);
            const allManagers = people.filter(p => p.role === 'مدیر' && p.active).sort((a, b) => getAvg(b) - getAvg(a)).slice(0, 3);
            fillTopTable('top-all', [...allTeachers, ...allDeputies, ...allManagers]);

            const ruralTeachers = people.filter(p => p.role === 'آموزگار' && p.active && p.location === 'روستایی').sort((a, b) => getAvg(b) - getAvg(a)).slice(0, 10);
            const ruralDeputy = people.filter(p => p.role === 'معاون آموزشی' && p.active && p.location === 'روستایی').sort((a, b) => getAvg(b) - getAvg(a))[0];
            const ruralManager = people.filter(p => p.role === 'مدیر' && p.active && p.location === 'روستایی').sort((a, b) => getAvg(b) - getAvg(a))[0];
            fillTopTable('top-rural', [...ruralTeachers, ruralDeputy, ruralManager]);

            const urbanTeachers = people.filter(p => p.role === 'آموزگار' && p.active && p.location === 'شهری').sort((a, b) => getAvg(b) - getAvg(a)).slice(0, 10);
            const urbanDeputy = people.filter(p => p.role === 'معاون آموزشی' && p.active && p.location === 'شهری').sort((a, b) => getAvg(b) - getAvg(a))[0];
            const urbanManager = people.filter(p => p.role === 'مدیر' && p.active && p.location === 'شهری').sort((a, b) => getAvg(b) - getAvg(a))[0];
            fillTopTable('top-urban', [...urbanTeachers, urbanDeputy, urbanManager]);

            const girlsTeachers = people.filter(p => p.role === 'آموزگار' && p.active && p.gender === 'دخترانه').sort((a, b) => getAvg(b) - getAvg(a)).slice(0, 10);
            const girlsDeputy = people.filter(p => p.role === 'معاون آموزشی' && p.active && p.gender === 'دخترانه').sort((a, b) => getAvg(b) - getAvg(a))[0];
            const girlsManager = people.filter(p => p.role === 'مدیر' && p.active && p.gender === 'دخترانه').sort((a, b) => getAvg(b) - getAvg(a))[0];
            fillTopTable('top-girls', [...girlsTeachers, girlsDeputy, girlsManager]);

            const boysTeachers = people.filter(p => p.role === 'آموزگار' && p.active && p.gender === 'پسرانه').sort((a, b) => getAvg(b) - getAvg(a)).slice(0, 10);
            const boysDeputy = people.filter(p => p.role === 'معاون آموزشی' && p.active && p.gender === 'پسرانه').sort((a, b) => getAvg(b) - getAvg(a))[0];
            const boysManager = people.filter(p => p.role === 'مدیر' && p.active && p.gender === 'پسرانه').sort((a, b) => getAvg(b) - getAvg(a))[0];
            fillTopTable('top-boys', [...boysTeachers, boysDeputy, boysManager]);
        }
        function getAvg(p) {
            const reportKey = `${p.role}_${p.name}_${p.role === 'آموزگار' ? p.grade : ''}`;
            const report = reportCards.find(r => r.key === reportKey) || { scores: {} };
            let total = 0, count = 0;
            for (const key in report.scores) {
                total += report.scores[key];
                if (report.scores[key] > 0) count++;
            }
            return count ? total / count : 0;
        }
        function fillTopTable(tableId, list) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            tbody.innerHTML = '';
            list.filter(p => p).forEach((p, idx) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${idx + 1}</td>
                    <td>${p.name}</td>
                    <td>${p.role}</td>
                    <td>${getAvg(p).toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        }
        function printTopPerformers() {
            const content = document.getElementById('top-performers').outerHTML;
            const win = window.open('', '_blank');
            win.document.write('<html dir="rtl"><head><title>چاپ برترین‌ها</title><style>table, th, td {border: 1px solid black; border-collapse: collapse; padding: 8px;}</style></head><body>' + content + '</body></html>');
            win.document.close();
            win.print();
        }

        // Export to Excel
        function exportToExcel() {
            const filteredPeople = filterPeopleByCriteria('summary');
            filteredPeople.sort((a, b) => {
                if (a.role === 'آموزگار' && b.role === 'آموزگار') {
                    const grades = ['اول', 'دوم', 'سوم', 'چهارم', 'پنجم', 'ششم', 'سایر'];
                    return grades.indexOf(a.grade) - grades.indexOf(b.grade);
                }
                return a.role.localeCompare(b.role);
            });
            const data = filteredPeople.map(p => {
                const reportKey = `${p.role}_${p.name}_${p.role === 'آموزگار' ? p.grade : ''}`;
                const report = reportCards.find(r => r.key === reportKey) || { scores: {}, comments: {} };
                let total = 0, count = 0;
                for (const key in report.scores) {
                    total += report.scores[key];
                    if (report.scores[key] > 0) count++;
                }
                const avg = count ? (total / count).toFixed(2) : 0;
                const noteCount = notes.filter(n => n.role === p.role && n.person === p.name).length;
                const notesText = notes.filter(n => n.role === p.role && n.person === p.name).map(n => n.text).join('; ');
                let fileCount = 0;
                let fileNames = '';
                let fileDescriptions = '';
                let fileCategories = '';
                const scoreColumns = {};
                const commentColumns = {};
                (criteria[p.role] || []).forEach(c => {
                    c.indicators.forEach(ind => {
                        const key = `${c.axis}-${ind}`;
                        scoreColumns[`امتیاز ${c.axis} - ${ind}`] = report.scores[key] || 0;
                        commentColumns[`نظر ${c.axis} - ${ind}`] = report.comments[key] || '-';
                    });
                });
                return {
                    'نام': p.name,
                    'کد پرسنلی': p.personnelCode,
                    'کد ملی': p.nationalCode,
                    'نقش': p.role,
                    'نام مدرسه': p.schoolName,
                    'دوره': p.period,
                    'پایه': p.grade || '-',
                    'جنسیت': p.gender,
                    'نوع': p.type,
                    'تعداد دانش‌آموزان': p.studentCount,
                    'موقعیت': p.location,
                    'معدل': avg,
                    'نمره ارزشیابی': total,
                    'تعداد یادداشت': noteCount,
                    'یادداشت‌ها': notesText,
                    'تعداد فایل': fileCount,
                    'نام فایل‌ها': fileNames,
                    'توضیحات فایل‌ها': fileDescriptions,
                    'دسته‌بندی فایل‌ها': fileCategories,
                    'وضعیت': avg >= 8 ? 'عالی' : avg >= 5 ? 'متوسط' : 'نیاز به بهبود',
                    'پیشنهاد': avg >= 8 ? 'تشویقی' : avg >= 5 ? 'اخطار' : 'توبیخ',
                    ...scoreColumns,
                    ...commentColumns
                };
            });
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'ارزیابی کادر مدرسه');
            XLSX.writeFile(wb, 'school_staff_evaluation.xlsx');
            Swal.fire({
                title: 'موفقیت',
                text: 'فایل اکسل با موفقیت تولید شد! 📑',
                icon: 'success',
                confirmButtonText: 'باشه',
                confirmButtonColor: '#A5B4FC',
                animation: true,
                customClass: {
                    icon: 'animated-icon'
                }
            });
        }

        // Search Person
        function searchPerson(section) {
            const search = document.getElementById(`${section}-search`).value.toLowerCase();
            const personSelect = document.getElementById(`${section}-person`);
            const options = personSelect.options;
            for (let i = 1; i < options.length; i++) {
                if (options[i].text.toLowerCase().includes(search)) {
                    options[i].selected = true;
                    loadSummary(); // or loadReportCard if report
                    return;
                }
            }
            Swal.fire({
                title: 'خطا',
                text: 'فرد یافت نشد!',
                icon: 'error',
                timer: 1500,
                showConfirmButton: false
            });
        }

        // Strategic Analysis
        function generateStrategicAnalysis() {
            const report = document.getElementById('strategic-report');
            report.innerHTML = '';
            const overallAvg = calculateOverallAverage();
            const lowPerformers = people.filter(p => getAvg(p) < 5).length;
            const mediumPerformers = people.filter(p => getAvg(p) >= 5 && getAvg(p) < 8).length;
            const highPerformers = people.filter(p => getAvg(p) >= 8).length;
            const crisis = overallAvg < 5 || lowPerformers > people.length * 0.3;
            let analysis = '<h4>تحلیل راهبردی سیستم</h4>';
            analysis += '<div class="table-container"><table><thead><tr><th>معیار</th><th>مقدار</th><th>تحلیل</th><th>پیشنهاد</th></tr></thead><tbody>';
            analysis += `<tr><td>میانگین کلی</td><td>${overallAvg}</td><td>${overallAvg >= 8 ? 'عالی' : overallAvg >= 5 ? 'متوسط' : 'ضعیف'}</td><td>${overallAvg >= 8 ? 'حفظ و ارتقا' : overallAvg >= 5 ? 'بهبود هدفمند' : 'بازسازی اساسی'}</td></tr>`;
            analysis += `<tr><td>تعداد عالی</td><td>${highPerformers}</td><td>${highPerformers > people.length * 0.5 ? 'قوی' : 'متوسط'}</td><td>استفاده از برترین‌ها برای mentorship</td></tr>`;
            analysis += `<tr><td>تعداد متوسط</td><td>${mediumPerformers}</td><td>${mediumPerformers > people.length * 0.3 ? 'نیاز به توجه' : 'خوب'}</td><td>برنامه‌های آموزشی برای ارتقا</td></tr>`;
            analysis += `<tr><td>تعداد ضعیف</td><td>${lowPerformers}</td><td>${lowPerformers < people.length * 0.1 ? 'خوب' : 'نگران‌کننده'}</td><td>شناسایی علل و اقدام اصلاحی</td></tr>`;
            analysis += '</tbody></table></div>';
            if (crisis) {
                analysis += '<p>وضعیت بحرانی: میانگین پایین. راهکار: جلسات اضطراری, ارزیابی خارجی, تغییرات ساختاری, حمایت روانی.</p>';
            } else if (overallAvg < 8) {
                analysis += '<p>نیاز به بهبود: تمرکز روی نقاط ضعف, آموزش مداوم, انگیزش.</p>';
            } else {
                analysis += '<p>عالی: ادامه و نوآوری.</p>';
            }
            report.innerHTML = analysis;
        }

        // Top Performers
        function loadTopPerformers() {
            const topAllTbody = document.querySelector('#top-all tbody');
            const topRuralTbody = document.querySelector('#top-rural tbody');
            const topUrbanTbody = document.querySelector('#top-urban tbody');
            const topGirlsTbody = document.querySelector('#top-girls tbody');
            const topBoysTbody = document.querySelector('#top-boys tbody');
            topAllTbody.innerHTML = '';
            topRuralTbody.innerHTML = '';
            topUrbanTbody.innerHTML = '';
            topGirlsTbody.innerHTML = '';
            topBoysTbody.innerHTML = '';

            const rankedPeople = people.filter(p => p.active).map(p => {
                const reportKey = `${p.role}_${p.name}_${p.role === 'آموزگار' ? p.grade : ''}`;
                const report = reportCards.find(r => r.key === reportKey) || { scores: {} };
                let total = 0, count = 0;
                for (const key in report.scores) {
                    total += report.scores[key];
                    if (report.scores[key] > 0) count++;
                }
                return { ...p, avg: count ? total / count : 0 };
            }).sort((a, b) => b.avg - a.avg);

            rankedPeople.slice(0, 5).forEach((p, i) => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${i + 1}</td><td>${p.name}</td><td>${p.role}</td><td>${p.avg.toFixed(2)}</td>`;
                topAllTbody.appendChild(row);
            });

            rankedPeople.filter(p => p.location === 'روستایی').slice(0, 5).forEach((p, i) => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${i + 1}</td><td>${p.name}</td><td>${p.role}</td><td>${p.avg.toFixed(2)}</td>`;
                topRuralTbody.appendChild(row);
            });

            rankedPeople.filter(p => p.location === 'شهری').slice(0, 5).forEach((p, i) => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${i + 1}</td><td>${p.name}</td><td>${p.role}</td><td>${p.avg.toFixed(2)}</td>`;
                topUrbanTbody.appendChild(row);
            });

            rankedPeople.filter(p => p.gender === 'دخترانه').slice(0, 5).forEach((p, i) => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${i + 1}</td><td>${p.name}</td><td>${p.role}</td><td>${p.avg.toFixed(2)}</td>`;
                topGirlsTbody.appendChild(row);
            });

            rankedPeople.filter(p => p.gender === 'پسرانه').slice(0, 5).forEach((p, i) => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${i + 1}</td><td>${p.name}</td><td>${p.role}</td><td>${p.avg.toFixed(2)}</td>`;
                topBoysTbody.appendChild(row);
            });
        }

        // Print Top Performers
        function printTopPerformers() {
            let content = `
                <html dir="rtl">
                <head>
                    <meta charset="UTF-8">
                    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap" rel="stylesheet">
                    <style>
                        body {
                            font-family: Vazirmatn, sans-serif;
                            font-size: 12px;
                            background: #fff;
                            color: #1F2937;
                            margin: 20px;
                        }
                        h3, h4 {
                            color: #1F2937;
                            text-align: center;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 10px 0;
                        }
                        th, td {
                            border: 1px solid #D1D5DB;
                            padding: 8px;
                            text-align: center;
                        }
                        th {
                            background: #A5B4FC;
                            color: #1F2937;
                        }
                        .section {
                            margin-bottom: 20px;
                            page-break-inside: avoid;
                        }
                    </style>
                </head>
                <body>
                    <h3>برترین‌ها 🏆</h3>
            `;
            const rankedPeople = people.filter(p => p.active).map(p => {
                const reportKey = `${p.role}_${p.name}_${p.role === 'آموزگار' ? p.grade : ''}`;
                const report = reportCards.find(r => r.key === reportKey) || { scores: {} };
                let total = 0, count = 0;
                for (const key in report.scores) {
                    total += report.scores[key];
                    if (report.scores[key] > 0) count++;
                }
                return { ...p, avg: count ? total / count : 0 };
            }).sort((a, b) => b.avg - a.avg);

            content += `
                <div class="section">
                    <h4>برترین کلی</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>رتبه</th>
                                <th>نام</th>
                                <th>نقش</th>
                                <th>معدل</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rankedPeople.slice(0, 5).map((p, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td>${p.name}</td>
                                    <td>${p.role}</td>
                                    <td>${p.avg.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="section">
                    <h4>برترین روستا</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>رتبه</th>
                                <th>نام</th>
                                <th>نقش</th>
                                <th>معدل</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rankedPeople.filter(p => p.location === 'روستایی').slice(0, 5).map((p, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td>${p.name}</td>
                                    <td>${p.role}</td>
                                    <td>${p.avg.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="section">
                    <h4>برترین شهر</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>رتبه</th>
                                <th>نام</th>
                                <th>نقش</th>
                                <th>معدل</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rankedPeople.filter(p => p.location === 'شهری').slice(0, 5).map((p, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td>${p.name}</td>
                                    <td>${p.role}</td>
                                    <td>${p.avg.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="section">
                    <h4>برترین دخترانه</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>رتبه</th>
                                <th>نام</th>
                                <th>نقش</th>
                                <th>معدل</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rankedPeople.filter(p => p.gender === 'دخترانه').slice(0, 5).map((p, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td>${p.name}</td>
                                    <td>${p.role}</td>
                                    <td>${p.avg.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="section">
                    <h4>برترین پسرانه</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>رتبه</th>
                                <th>نام</th>
                                <th>نقش</th>
                                <th>معدل</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rankedPeople.filter(p => p.gender === 'پسرانه').slice(0, 5).map((p, i) => `
                                <tr>
                                    <td>${i + 1}</td>
                                    <td>${p.name}</td>
                                    <td>${p.role}</td>
                                    <td>${p.avg.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </body>
            </html>
            `;
            const printWindow = window.open('', '_blank');
            printWindow.document.write(content);
            printWindow.document.close();
            printWindow.print();
        }

        // Initialize
        filterPeople();
        loadCriteria();
        updateStats();
    </script>
</body>
</html>
